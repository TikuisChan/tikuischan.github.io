<!DOCTYPE html>
<head>
    <title>Self-driving Car</title>
    <link rel="stylesheet" href="style.css">
    <script src="main.js"></script>
    <script src="visualizer.js"></script>
    <script src="agent_fc.js"></script>
    <script src="utils.js"></script>
    <script src="car.js"></script>
    <script src="road.js"></script>
    <script src="controls.js"></script>
    <script src="sensor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
    <script type="text/javascript">
        function trainMyStyle () {
            cancelAnimationFrame(game.requestID);
            // console.table(game.cars[0].carCam);
            // window.localStorage.setItem('playRecord1', game.cars[0].carCam);
            let myStyle = new FC([7, 12, 12, 4]);
            const allData = game.cars[0].carCam;
            let testData = [];
            let trainData = [];
            console.log('Total number of data:', allData.length);
            for (let i = 0; i < allData.length; i++) {
                if (Math.random() > 0.2) {
                    trainData.push(allData[i]);
                } else {
                    testData.push(allData[i]);
                }
            }
            
            console.log('Training data:', trainData.length);
            console.log('Testing data:', testData.length);
            for (let epoch=1; epoch < 20; epoch++) {
                trainData.forEach(data => {
                    myStyle.fit(data[0], data[1].map(y=>y * 1));
                });
                let testLoss = 0;
                trainData.forEach(data => {
                    let pred = myStyle.forward(data[0], data[1].map(y=>y * 1));
                    for (let j = 0; j < pred.length; j++) {
                        testLoss += (data[1][j] - pred[j]) ** 2;
                    }
                });
                console.log('Epoch:', epoch, 'Loss:', testLoss);
            }
            // store to local storage
            if (window.localStorage.getItem('myStyle')) {
                localStorage.removeItem('myStyle');
            }
            window.localStorage.setItem('myStyle', JSON.stringify(myStyle));
        }


        function restartGame (play) {
            // clear all chart
            Chart.helpers.each(Chart.instances, function (instance) {
                instance.destroy();
            }); 
            switch (play) {
                case "play":
                    game.play(false);
                    break;
                
                case "evolution":
                    game.evoChart = new Chart(
                        game.chartCanvas,
                        game.config,
                    );
                    game.evolution(true);
                    break;

                case "REC":
                    game.play(true);
            }
        }

        function linearFunc (X) {
            return X[0] > X[1] ? 1 : 0
        }

        // same as $('document').ready(function(){});
        document.addEventListener("DOMContentLoaded", function () {
            game = new Game();
            game.initGame();
            // game.evolution();
        });
    </script>
</head>
<body>
    <canvas id="carCanvas"></canvas>
    <div class="verticalBtn">
        <button id="restart-btn" onclick="javascript: restartGame('evolution')">Start Evolution</button>
        <button id="restart-btn" onclick="javascript: restartGame('play')">Play</button>
        <button id="restart-btn" onclick="javascript: restartGame('REC')">REC Play</button>
        <button id="restart-btn" onclick="javascript: trainMyStyle()">Train My Style</button>
    </div>
    <canvas id="nnCanvas"></canvas>
    <div id="evo-chart">
        <canvas id="evolution"  width="500" height="250"></canvas>
    </div>
</body>